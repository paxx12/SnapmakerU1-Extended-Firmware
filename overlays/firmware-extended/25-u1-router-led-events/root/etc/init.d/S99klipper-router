#!/bin/sh

ROUTER_PY="/usr/local/sbin/klipper-routerd"
ROUTER_CFG="/home/lava/printer_data/config/extended/router/klipper_router.cfg"
ROUTER_RUNTIME_CFG="/home/lava/printer_data/config/extended/router/klipper_router.runtime.cfg"
INSTANCES_DIR="/home/lava/printer_data/config/extended/router/instances"
PIDFILE="/var/run/klipper-router.pid"
LOGFILE="/home/lava/printer_data/logs/klipper-router.log"
EXTENDED_CFG="/home/lava/printer_data/config/extended/extended2.cfg"

router_enabled() {
    /usr/local/bin/extended-config.py get "$EXTENDED_CFG" router enabled false 2>/dev/null
}

is_running() {
    [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")" 2>/dev/null
}

build_runtime_cfg() {
    runtime_cfg="$ROUTER_RUNTIME_CFG"
    cp "$ROUTER_CFG" "$runtime_cfg" || return 1

    if [ -d "$INSTANCES_DIR" ]; then
        find "$INSTANCES_DIR" -mindepth 1 -maxdepth 1 -type d | sort | while read -r dir; do
            name="$(basename "$dir")"
            if ! grep -q "^\[klippy $name\]$" "$runtime_cfg"; then
                cat >> "$runtime_cfg" <<EOF

[klippy $name]
sock: /home/lava/printer_data/comms/klippy-router-$name.sock
on_connect: M118 Router connected to $name
EOF
            fi
        done
    fi

    echo "$runtime_cfg"
}

start() {
    if [ "$(router_enabled)" != "true" ]; then
        echo "[router] disabled in extended2.cfg, not starting Klipper Router."
        return 0
    fi

    if [ ! -x "$ROUTER_PY" ]; then
        echo "Klipper Router is not installed"
        return 1
    fi

    if [ ! -f "$ROUTER_CFG" ]; then
        echo "Klipper Router config not found: $ROUTER_CFG"
        return 0
    fi

    if is_running; then
        echo "Klipper Router already running"
        return 0
    fi

    mkdir -p /home/lava/printer_data/logs

    runtime_cfg="$(build_runtime_cfg)"
    if [ -z "$runtime_cfg" ] || [ ! -f "$runtime_cfg" ]; then
        echo "Failed to prepare runtime router config"
        return 1
    fi

    echo "Starting Klipper Router"
    start-stop-daemon -S -b -m -u lava \
        -p "$PIDFILE" \
        -x /usr/bin/python3 -- "$ROUTER_PY" -c "$runtime_cfg" >> "$LOGFILE" 2>&1
}

stop() {
    echo "Stopping Klipper Router"
    if [ -f "$PIDFILE" ]; then
        start-stop-daemon -K -p "$PIDFILE" -s TERM
        rm -f "$PIDFILE"
    else
        echo "Klipper Router not running"
    fi
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        stop
        sleep 1
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0
