[gcode_macro ROUTER_GCODE_SCRIPT]
gcode:
    {% if 'TARGET' not in params %}
        {action_raise_error("ROUTER_GCODE_SCRIPT requires TARGET")}
    {% endif %}
    {% if 'SCRIPT' not in params %}
        {action_raise_error("ROUTER_GCODE_SCRIPT requires SCRIPT")}
    {% endif %}
    {action_call_remote_method("router/gcode/script", target=params.TARGET, script=params.SCRIPT)}

[gcode_macro ROUTER_EVENT_SUBSCRIBE]
gcode:
    {% if 'EVENT' not in params %}
        {action_raise_error("ROUTER_EVENT_SUBSCRIBE requires EVENT")}
    {% endif %}
    {% if 'GCODE' not in params %}
        {action_raise_error("ROUTER_EVENT_SUBSCRIBE requires GCODE")}
    {% endif %}
    {action_call_remote_method("router/event/subscribe", event=params.EVENT, gcode=params.GCODE)}

[gcode_macro ROUTER_EVENT_TRIGGER]
gcode:
    {% if 'EVENT' not in params %}
        {action_raise_error("ROUTER_EVENT_TRIGGER requires EVENT")}
    {% endif %}
    {action_call_remote_method("router/event/trigger", event=params.EVENT)}

[gcode_macro ROUTER_PRINTERS_LIST]
gcode:
    {action_call_remote_method("router/printers/list", gcode_callback="ROUTER_PRINTERS_RESPONSE")}

[gcode_macro ROUTER_PRINTERS_RESPONSE]
gcode:
    M118 Printers: {rawparams}

[gcode_macro ROUTER_OBJECTS_LIST]
gcode:
    {% if 'TARGET' not in params %}
        {action_raise_error("ROUTER_OBJECTS_LIST requires TARGET")}
    {% endif %}
    {action_call_remote_method("router/objects/list", target=params.TARGET, gcode_callback="ROUTER_OBJECTS_LIST_RESPONSE")}

[gcode_macro ROUTER_OBJECTS_LIST_RESPONSE]
gcode:
    M118 Objects: {rawparams}

[gcode_macro ROUTER_OBJECTS_QUERY]
gcode:
    {% if 'TARGET' not in params %}
        {action_raise_error("ROUTER_OBJECTS_QUERY requires TARGET")}
    {% endif %}
    {% if 'OBJECTS' not in params %}
        {action_raise_error("ROUTER_OBJECTS_QUERY requires OBJECTS")}
    {% endif %}
    {% set obj_list = params.OBJECTS.split(',') %}
    {% set objects_dict = {} %}
    {% for obj in obj_list %}
        {% set _ = objects_dict.update({obj.strip(): None}) %}
    {% endfor %}
    {action_call_remote_method("router/objects/query", target=params.TARGET, objects=objects_dict, gcode_callback="ROUTER_OBJECTS_QUERY_RESPONSE")}

[gcode_macro ROUTER_OBJECTS_QUERY_RESPONSE]
gcode:
    M118 Status: {rawparams}

[gcode_macro ROUTER_OBJECTS_SUBSCRIBE]
gcode:
    {% if 'TARGET' not in params %}
        {action_raise_error("ROUTER_OBJECTS_SUBSCRIBE requires TARGET")}
    {% endif %}
    {% if 'OBJECTS' not in params %}
        {action_raise_error("ROUTER_OBJECTS_SUBSCRIBE requires OBJECTS")}
    {% endif %}
    {% set obj_list = params.OBJECTS.split(',') %}
    {% set objects_dict = {} %}
    {% for obj in obj_list %}
        {% set _ = objects_dict.update({obj.strip(): None}) %}
    {% endfor %}
    {action_call_remote_method("router/objects/subscribe", target=params.TARGET, objects=objects_dict, gcode_callback=params.CALLBACK|default("ROUTER_OBJECTS_UPDATE"))}

[gcode_macro ROUTER_OBJECTS_UPDATE]
description: Called when subscribed objects change
gcode:
    M118 Update: {rawparams}

[gcode_macro ROUTER_ON_READY]
description: Called when this printer is ready
gcode:
    M118 Router ready

[gcode_macro ROUTER_ON_CONNECTED]
description: Called when another printer connects (PRINTER=name)
gcode:
    M118 Router: {params.PRINTER} connected
    {% if 'PRINTER' in params and params.PRINTER|lower == "led" %}
        UPDATE_DELAYED_GCODE ID=ROUTER_LED_STATUS_SUBSCRIBE_INIT DURATION=0.5
    {% endif %}

[gcode_macro ROUTER_ON_DISCONNECTED]
description: Called when another printer disconnects (PRINTER=name)
gcode:
    M118 Router: {params.PRINTER} disconnected
