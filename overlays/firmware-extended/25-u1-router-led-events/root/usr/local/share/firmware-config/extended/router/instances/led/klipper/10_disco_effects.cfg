# ==== DISCO PARTY ====

[gcode_macro DISCO_PARTY]
variable_active: 0
gcode:
    DISCO_STOP
    SET_GCODE_VARIABLE MACRO=DISCO_PARTY VARIABLE=active VALUE=1
    UPDATE_DELAYED_GCODE ID=party_loop DURATION=0.1

[gcode_macro DISCO_BREATHING]
variable_active: 0
variable_brightness: 0.1
variable_direction: 1
gcode:
    DISCO_STOP
    SET_GCODE_VARIABLE MACRO=DISCO_BREATHING VARIABLE=active VALUE=1
    UPDATE_DELAYED_GCODE ID=breathing_loop DURATION=0.1

[delayed_gcode party_loop]
gcode:
    {% if printer["gcode_macro DISCO_PARTY"].active %}
        {% set r = (range(0, 100) | random) / 100.0 %}
        {% set g = (range(0, 100) | random) / 100.0 %}
        {% set b = (range(0, 100) | random) / 100.0 %}
        SET_LED LED=disco_led RED={r} GREEN={g} BLUE={b}
        UPDATE_DELAYED_GCODE ID=party_loop DURATION=0.1
    {% endif %}

[delayed_gcode breathing_loop]
gcode:
    {% if printer["gcode_macro DISCO_BREATHING"].active %}
        {% set brightness = printer["gcode_macro DISCO_BREATHING"].brightness %}
        {% set direction = printer["gcode_macro DISCO_BREATHING"].direction %}
        {% if brightness >= 1.0 %}
            {% set direction = -1 %}
        {% elif brightness <= 0.1 %}
            {% set direction = 1 %}
        {% endif %}
        {% set next_brightness = brightness + (0.05 * direction) %}
        {% if next_brightness > 1.0 %}
            {% set next_brightness = 1.0 %}
        {% elif next_brightness < 0.0 %}
            {% set next_brightness = 0.0 %}
        {% endif %}
        SET_GCODE_VARIABLE MACRO=DISCO_BREATHING VARIABLE=brightness VALUE={next_brightness}
        SET_GCODE_VARIABLE MACRO=DISCO_BREATHING VARIABLE=direction VALUE={direction}
        SET_LED LED=disco_led RED=0 GREEN={next_brightness} BLUE={next_brightness}
        UPDATE_DELAYED_GCODE ID=breathing_loop DURATION=0.1
    {% endif %}

[gcode_macro DISCO_STOP]
gcode:
    SET_GCODE_VARIABLE MACRO=DISCO_PARTY VARIABLE=active VALUE=0
    UPDATE_DELAYED_GCODE ID=party_loop DURATION=0
    SET_GCODE_VARIABLE MACRO=DISCO_BREATHING VARIABLE=active VALUE=0
    UPDATE_DELAYED_GCODE ID=breathing_loop DURATION=0
    {% set ready = params.READY|default(0)|int %}
    {% if ready == 1 %}
      STATUS_READY
    {% endif %}

# Disco macros
[gcode_macro DISCO_IDLE]
gcode:
  DISCO_STOP
  SET_LED LED=disco_led RED=0 GREEN=0 BLUE=0.3

[gcode_macro DISCO_PRINTING]
gcode:
  DISCO_STOP
  SET_LED LED=disco_led RED=0 GREEN=0.5 BLUE=0

[gcode_macro DISCO_HEATING]
gcode:
  DISCO_STOP
  SET_LED LED=disco_led RED=0.8 GREEN=0.2 BLUE=0

[gcode_macro DISCO_COMPLETE]
gcode:
  DISCO_STOP
  {% for i in range(20) %}
    SET_LED LED=disco_led RED={(i % 3) / 3.0} GREEN={((i+1) % 3) / 3.0} BLUE={((i+2) % 3) / 3.0}
    G4 P100
  {% endfor %}

[gcode_macro DISCO_ERROR]
gcode:
  DISCO_STOP
  {% for i in range(10) %}
    SET_LED LED=disco_led RED=1 GREEN=0 BLUE=0
    G4 P200
    SET_LED LED=disco_led RED=0 GREEN=0 BLUE=0
    G4 P200
  {% endfor %}
