# ==== ROUTER OBJECT SUBSCRIPTIONS (LED instance) ====

[gcode_macro SUBSCRIBE_MAIN_STATUS]
description: Subscribe LED instance to main print_stats updates
gcode:
    {% set objects = {
        "webhooks": ["state"],
        "print_stats": ["state"],
        "pause_resume": ["is_paused"],
        "idle_timeout": ["state"],
        "toolhead": ["homed_axes"],
        "probe": ["last_z_result"],
        "extruder": ["temperature", "target"],
        "heater_bed": ["temperature", "target"]
    } %}
    {action_call_remote_method("router/objects/subscribe", target="main", objects=objects, gcode_callback="ON_STATUS_UPDATE")}
    UPDATE_DELAYED_GCODE ID=LED_SYNC_MAIN_STATUS_ONCE DURATION=0.2
    M118 [LED] Subscribed: main print_stats/pause/idle/toolhead/heaters

[gcode_macro ON_STATUS_UPDATE]
description: Handle routed print_stats state from main
variable_last_status: "unknown"
variable_last_webhooks_state: "ready"
variable_last_state: "standby"
variable_last_paused: "false"
variable_last_idle_state: "ready"
variable_last_homed_axes: ""
variable_last_e_temp: 0.0
variable_last_e_target: 0.0
variable_last_b_temp: 0.0
variable_last_b_target: 0.0
variable_last_probe_z: 0.0
variable_last_probe_time: 0.0
variable_last_partial_home_time: 0.0
gcode:
    {% set now = printer.toolhead.print_time|float %}
    {% set webhooks_state = params.WEBHOOKS_STATE|default(printer["gcode_macro ON_STATUS_UPDATE"].last_webhooks_state)|lower %}
    {% set state = params.PRINT_STATS_STATE|default(printer["gcode_macro ON_STATUS_UPDATE"].last_state)|lower %}
    {% set paused_raw = params.PAUSE_RESUME_IS_PAUSED|default(printer["gcode_macro ON_STATUS_UPDATE"].last_paused)|string|lower %}
    {% set paused = paused_raw in ["true", "1"] %}
    {% set idle_state = params.IDLE_TIMEOUT_STATE|default(printer["gcode_macro ON_STATUS_UPDATE"].last_idle_state)|string|lower %}
    {% set homed_axes = params.TOOLHEAD_HOMED_AXES|default(printer["gcode_macro ON_STATUS_UPDATE"].last_homed_axes)|string|lower %}
    {% set homed_axes_updated = params.TOOLHEAD_HOMED_AXES is defined %}
    {% set e_temp = params.EXTRUDER_TEMPERATURE|default(printer["gcode_macro ON_STATUS_UPDATE"].last_e_temp)|float %}
    {% set e_target = params.EXTRUDER_TARGET|default(printer["gcode_macro ON_STATUS_UPDATE"].last_e_target)|float %}
    {% set b_temp = params.HEATER_BED_TEMPERATURE|default(printer["gcode_macro ON_STATUS_UPDATE"].last_b_temp)|float %}
    {% set b_target = params.HEATER_BED_TARGET|default(printer["gcode_macro ON_STATUS_UPDATE"].last_b_target)|float %}
    {% set probe_z = params.PROBE_LAST_Z_RESULT|default(printer["gcode_macro ON_STATUS_UPDATE"].last_probe_z)|float %}
    {% set probe_updated = params.PROBE_LAST_Z_RESULT is defined %}
    {% set last_probe_time = printer["gcode_macro ON_STATUS_UPDATE"].last_probe_time|float %}
    {% set last_partial_home_time = printer["gcode_macro ON_STATUS_UPDATE"].last_partial_home_time|float %}
    {% if probe_updated and state in ["standby", "printing"] %}
        {% set last_probe_time = now %}
    {% endif %}
    {% if homed_axes_updated and homed_axes != "" and homed_axes != "xyz" %}
        {% set last_partial_home_time = now %}
    {% endif %}
    {% set was_error = printer["gcode_macro ON_STATUS_UPDATE"].last_status == "error" %}
    {% set heating = (not was_error)
        and (not paused)
        and (webhooks_state != "shutdown")
        and (state not in ["error", "cancelled", "complete", "paused"])
        and ((e_target > 0 and (e_target - e_temp) > 2.0) or (b_target > 0 and (b_target - b_temp) > 2.0)) %}
    {% set desired = "ready" %}

    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_webhooks_state VALUE="'{webhooks_state}'"
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_state VALUE="'{state}'"
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_paused VALUE="'{paused_raw}'"
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_idle_state VALUE="'{idle_state}'"
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_homed_axes VALUE="'{homed_axes}'"
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_e_temp VALUE={e_temp}
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_e_target VALUE={e_target}
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_b_temp VALUE={b_temp}
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_b_target VALUE={b_target}
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_probe_z VALUE={probe_z}
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_probe_time VALUE={last_probe_time}
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_partial_home_time VALUE={last_partial_home_time}

    {% if state == "error" %}
        {% set desired = "error" %}
    {% elif state == "cancelled" %}
        {% set desired = "error" %}
    {% elif webhooks_state == "shutdown" %}
        {% if state in ["printing", "paused"] %}
            {% set desired = "error" %}
        {% else %}
            {% set desired = "shutdown" %}
        {% endif %}
    {% elif paused or state == "paused" %}
        {% set desired = "paused" %}
    {% elif heating %}
        {% set desired = "heating" %}
    {% elif state == "printing" %}
        {% set desired = "running" %}
    {% elif state == "complete" %}
        {% set desired = "complete" %}
    {% elif (now - last_probe_time) < 2.0 and state in ["standby", "printing"] %}
        {% set desired = "leveling" %}
    {% elif (now - last_partial_home_time) < 1.5 %}
        {% set desired = "homing" %}
    {% elif idle_state == "idle" %}
        {% set desired = "idle" %}
    {% elif idle_state in ["ready", "printing"] or state == "standby" %}
        {% set desired = "ready" %}
    {% endif %}

    {% if desired != printer["gcode_macro ON_STATUS_UPDATE"].last_status %}
        SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_status VALUE="'{desired}'"
        {% if desired == "running" %}
            STATUS_RUNNING
        {% elif desired == "paused" %}
            STATUS_PAUSED
        {% elif desired == "complete" %}
            STATUS_COMPLETE
        {% elif desired == "warning" %}
            STATUS_WARNING
        {% elif desired == "error" %}
            DISCO_STOP
            DISCO_ERROR
            STATUS_ERROR
        {% elif desired == "shutdown" %}
            DISCO_BREATHING
        {% elif desired == "heating" %}
            STATUS_HEATING
        {% elif desired == "homing" %}
            STATUS_HOMING
        {% elif desired == "leveling" %}
            STATUS_LEVELING
        {% elif desired == "idle" %}
            DISCO_IDLE
        {% else %}
            STATUS_READY
        {% endif %}
    {% endif %}

[gcode_macro ROUTER_ON_READY]
description: Router callback when LED instance is ready
gcode:
    M118 LED controller ready
    UPDATE_DELAYED_GCODE ID=LED_INIT_MAIN_STATUS_SUBSCRIPTION DURATION=2.0

[gcode_macro ROUTER_ON_CONNECTED]
description: Router callback when another printer connects
gcode:
    {% if params.PRINTER|lower == "main" %}
        UPDATE_DELAYED_GCODE ID=LED_MAIN_DISCONNECT_FALLBACK DURATION=0
        SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_webhooks_state VALUE="'ready'"
        SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_status VALUE="'unknown'"
        M118 Registering for main printer status updates
        UPDATE_DELAYED_GCODE ID=LED_INIT_MAIN_STATUS_SUBSCRIPTION DURATION=0.5
    {% endif %}

[gcode_macro ROUTER_ON_DISCONNECTED]
description: Router callback when another printer disconnects
gcode:
    {% if params.PRINTER|lower == "main" %}
        # Delay breathing fallback to avoid transient reconnect flaps while main is still on.
        UPDATE_DELAYED_GCODE ID=LED_MAIN_DISCONNECT_FALLBACK DURATION=8.0
    {% endif %}

[delayed_gcode LED_INIT_MAIN_STATUS_SUBSCRIPTION]
initial_duration: 0
gcode:
    SUBSCRIBE_MAIN_STATUS

[delayed_gcode LED_SYNC_MAIN_STATUS_ONCE]
initial_duration: 0
gcode:
    {action_call_remote_method("router/objects/query", target="main", objects={"webhooks": ["state"], "print_stats": ["state"], "pause_resume": ["is_paused"], "idle_timeout": ["state"], "toolhead": ["homed_axes"], "probe": ["last_z_result"], "extruder": ["temperature", "target"], "heater_bed": ["temperature", "target"]}, gcode_callback="ON_STATUS_UPDATE")}

[delayed_gcode LED_MAIN_DISCONNECT_FALLBACK]
initial_duration: 0
gcode:
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_webhooks_state VALUE="'shutdown'"
    SET_GCODE_VARIABLE MACRO=ON_STATUS_UPDATE VARIABLE=last_status VALUE="'shutdown'"
    DISCO_BREATHING
