# ==== ANDON TOWER STATUS LIGHT ====

[gcode_macro STATUS_RUNTIME]
variable_heating_active: 0
variable_heating_phase: 0
variable_homing_active: 0
variable_homing_phase: 0
variable_leveling_active: 0
variable_leveling_phase: 0
gcode:

[gcode_macro _STATUS_STOP_LOOPS]
gcode:
  SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=heating_active VALUE=0
  SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=homing_active VALUE=0
  SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=leveling_active VALUE=0
  UPDATE_DELAYED_GCODE ID=status_heating_loop DURATION=0
  UPDATE_DELAYED_GCODE ID=status_homing_loop DURATION=0
  UPDATE_DELAYED_GCODE ID=status_leveling_loop DURATION=0

[delayed_gcode status_heating_loop]
gcode:
  {% if printer["gcode_macro STATUS_RUNTIME"].heating_active|int == 1 %}
    {% set phase = printer["gcode_macro STATUS_RUNTIME"].heating_phase|int %}
    {% if phase == 0 %}
      SET_LED LED=disco_led RED=1.0 GREEN=0.85 BLUE=0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=heating_phase VALUE=1
    {% else %}
      SET_LED LED=disco_led RED=1.0 GREEN=0.45 BLUE=0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=heating_phase VALUE=0
    {% endif %}
    UPDATE_DELAYED_GCODE ID=status_heating_loop DURATION=0.35
  {% endif %}

[delayed_gcode status_homing_loop]
gcode:
  {% if printer["gcode_macro STATUS_RUNTIME"].homing_active|int == 1 %}
    {% set phase = printer["gcode_macro STATUS_RUNTIME"].homing_phase|int %}
    {% if phase == 0 %}
      SET_LED LED=disco_led RED=0 GREEN=0 BLUE=1.0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=homing_phase VALUE=1
    {% else %}
      SET_LED LED=disco_led RED=0 GREEN=0 BLUE=0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=homing_phase VALUE=0
    {% endif %}
    UPDATE_DELAYED_GCODE ID=status_homing_loop DURATION=0.2
  {% endif %}

[delayed_gcode status_leveling_loop]
gcode:
  {% if printer["gcode_macro STATUS_RUNTIME"].leveling_active|int == 1 %}
    {% set phase = printer["gcode_macro STATUS_RUNTIME"].leveling_phase|int %}
    {% if phase == 0 %}
      SET_LED LED=disco_led RED=0 GREEN=0 BLUE=1.0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=leveling_phase VALUE=1
    {% elif phase == 1 %}
      SET_LED LED=disco_led RED=1.0 GREEN=0.8 BLUE=0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=leveling_phase VALUE=2
    {% else %}
      SET_LED LED=disco_led RED=0 GREEN=1.0 BLUE=0
      SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=leveling_phase VALUE=0
    {% endif %}
    UPDATE_DELAYED_GCODE ID=status_leveling_loop DURATION=0.25
  {% endif %}

[gcode_macro STATUS_READY]
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_LED LED=disco_led RED=0 GREEN=0 BLUE=1.0
  {action_call_remote_method("router/event/trigger", event="led/status_ready")}

[gcode_macro STATUS_RUNNING]
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_LED LED=disco_led RED=0 GREEN=1.0 BLUE=0
  {action_call_remote_method("router/event/trigger", event="led/status_running")}

[gcode_macro STATUS_WARNING]
description: Needs attention (low filament, bed leveling, etc)
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_LED LED=disco_led RED=1.0 GREEN=0.8 BLUE=0
  {action_call_remote_method("router/event/trigger", event="led/status_warning")}

[gcode_macro STATUS_ERROR]
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_LED LED=disco_led RED=1.0 GREEN=0 BLUE=0
  {action_call_remote_method("router/event/trigger", event="led/status_error")}

[gcode_macro STATUS_HEATING]
description: Pulsing yellow while heating
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=heating_active VALUE=1
  UPDATE_DELAYED_GCODE ID=status_heating_loop DURATION=0.1
  {action_call_remote_method("router/event/trigger", event="led/status_heating")}

[gcode_macro STATUS_HOMING]
description: Flashing blue during homing
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=homing_active VALUE=1
  UPDATE_DELAYED_GCODE ID=status_homing_loop DURATION=0.1
  {action_call_remote_method("router/event/trigger", event="led/status_homing")}

[gcode_macro STATUS_LEVELING]
description: Rotating colors during bed leveling
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_GCODE_VARIABLE MACRO=STATUS_RUNTIME VARIABLE=leveling_active VALUE=1
  UPDATE_DELAYED_GCODE ID=status_leveling_loop DURATION=0.1
  {action_call_remote_method("router/event/trigger", event="led/status_leveling")}

[gcode_macro STATUS_COMPLETE]
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  {% for i in range(5) %}
    SET_LED LED=disco_led RED=0 GREEN=1.0 BLUE=0
    G4 P200
    SET_LED LED=disco_led RED=0 GREEN=0.3 BLUE=0
    G4 P200
  {% endfor %}
  {action_call_remote_method("router/event/trigger", event="led/status_complete")}
  STATUS_READY

[gcode_macro STATUS_PAUSED]
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_LED LED=disco_led RED=1.0 GREEN=0.8 BLUE=0
  {action_call_remote_method("router/event/trigger", event="led/status_paused")}

[gcode_macro STATUS_OFF]
gcode:
  DISCO_STOP
  _STATUS_STOP_LOOPS
  SET_LED LED=disco_led RED=0 GREEN=0 BLUE=0
  {action_call_remote_method("router/event/trigger", event="led/status_off")}
