#!/bin/sh

start() {
    mkdir -p /home/lava/printer_data/config/klipper
    cat <<EOF > /home/lava/printer_data/config/klipper/00_keep.cfg
# Create file similar to this to enable Klipper includes
# Do not modify nor remove this file.
#
# Adding config files here will be loaded on next system restart
# and when saving via Fluidd/Mainsail.
# You can force restart from SSH: /etc/init.d/S60klipper restart
EOF

    if [ -f /mnt/udisk/moonraker-recover.txt ]; then
        if [ -d /home/lava/printer_data/config/moonraker ]; then
            mkdir -p /home/lava/printer_data/config/moonraker.bak
            mv /home/lava/printer_data/config/moonraker/* /home/lava/printer_data/config/moonraker.bak
        fi
        rm -f /mnt/udisk/moonraker-recover.txt
    fi

    mkdir -p /home/lava/printer_data/config/moonraker
    cat <<EOF > /home/lava/printer_data/config/moonraker/00_keep.cfg
# Create file similar to this to enable Moonraker includes
# Do not modify nor remove this file.
#
# The config files added will be loaded on next system restart.
# You can force restart from SSH: /etc/init.d/S61moonraker restart
#
# If the include casues Moonraker issues, the WiFi will not connect.
# Create the file named "moonraker-recover.txt" on USB stick and restart printer.
EOF

    chown -R lava:lava /home/lava/printer_data/config
}

stop() {
    true
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        stop
        sleep 1
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0
