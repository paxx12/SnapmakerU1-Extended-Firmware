#!/bin/sh

[ ! -e /oem/.camera-native ] || exit 0

# Create temporary directory for timelapse files
umask 0022
mkdir -p /userdata/.tmp_timelapse
chown -R lava:lava /userdata/.tmp_timelapse

CMD_FAKE_SERVICE=/usr/local/bin/fake-service
CMD_FAKE_SERVICE_ARGS="--retry 3"
if [ -e /oem/.camera-log ]; then
    CMD_FAKE_SERVICE_ARGS="$CMD_FAKE_SERVICE_ARGS --syslog"
fi

CMD_CAPTURE="/usr/local/bin/capture-v4l2-raw-mpp --device /dev/video11 --format nv12 --jpeg-quality 7 --jpeg-sock /tmp/capture-mipi-jpeg.sock --mjpeg-sock /tmp/capture-mipi-mjpeg.sock --h264-sock /tmp/capture-mipi-h264.sock"

CMD_WEBRTC="/usr/local/bin/stream-webrtc --h264-sock /tmp/capture-mipi-h264.sock --webrtc-sock /tmp/capture-mipi-webrtc.sock"

CMD_HTTP="/usr/bin/python3 /usr/local/bin/stream-http.py --jpeg-sock /tmp/capture-mipi-jpeg.sock --mjpeg-sock /tmp/capture-mipi-mjpeg.sock --h264-sock /tmp/capture-mipi-h264.sock --webrtc-sock /tmp/capture-mipi-webrtc.sock --bind 127.0.0.1"

CMD_SNAP_MQTT="/usr/bin/python3 /usr/local/bin/stream-snap-mqtt.py --jpeg-sock /tmp/capture-mipi-jpeg.sock --publish-dir /home/lava/printer_data/camera"

start() {
    if [ ! -e /dev/video11 ]; then
        echo "MIPI camera device /dev/video11 not found, not starting."
        return
    fi

    printf "Starting capture-mipi-mpp: "
    start-stop-daemon -S -b -q -m -p /var/run/capture-mipi-mpp.pid -x $CMD_FAKE_SERVICE -- $CMD_FAKE_SERVICE_ARGS $CMD_CAPTURE
    echo "OK"

    printf "Starting stream-webrtc: "
    start-stop-daemon -S -b -q -m -p /var/run/stream-mipi-webrtc.pid -c lava -x $CMD_FAKE_SERVICE -- $CMD_FAKE_SERVICE_ARGS $CMD_WEBRTC
    echo "OK"

    printf "Starting stream-http: "
    start-stop-daemon -S -b -q -m -p /var/run/stream-mipi-http.pid -c lava -x $CMD_FAKE_SERVICE -- $CMD_FAKE_SERVICE_ARGS $CMD_HTTP
    echo "OK"

    printf "Starting stream-snap-mqtt: "
    start-stop-daemon -S -b -q -m -p /var/run/stream-mipi-snap-mqtt.pid -c lava -x $CMD_FAKE_SERVICE -- $CMD_FAKE_SERVICE_ARGS $CMD_SNAP_MQTT
    echo "OK"
}

stop() {
    printf "Stopping stream-snap-mqtt: "
    start-stop-daemon -K -q -p /var/run/stream-mipi-snap-mqtt.pid
    echo "OK"

    printf "Stopping stream-http: "
    start-stop-daemon -K -q -p /var/run/stream-mipi-http.pid
    echo "OK"

    printf "Stopping stream-webrtc: "
    start-stop-daemon -K -q -p /var/run/stream-mipi-webrtc.pid
    echo "OK"

    printf "Stopping capture-mipi-mpp: "
    start-stop-daemon -K -q -p /var/run/capture-mipi-mpp.pid
    echo "OK"
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        stop
        sleep 1
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0
