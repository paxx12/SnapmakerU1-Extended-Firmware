#!/bin/bash

#
# OctoEverywhere package manager
# Downloads and installs a pinned version of OctoEverywhere from GitHub
#

VERSION="4.6.6"
URL="https://github.com/QuinnDamerell/OctoPrint-OctoEverywhere/archive/refs/tags/${VERSION}.zip"
SHA256="8fedea60d50adc5763269cec47a46d81e534ea0066b790176fc819abea1b8db5"

# These paths are referenced in the init.d script
APP_DIR="/oem/apps/octoeverywhere"

check() {
    if [[ -d "$APP_DIR/latest" ]]; then
        echo "OctoEverywhere is installed."
        return 0
    else
        echo "OctoEverywhere is not installed."
        return 1
    fi
}

download() {
    rm -rf "$APP_DIR"
    mkdir -p "$APP_DIR"

    echo "Downloading OctoEverywhere ${VERSION} From GitHub..."
    if ! /usr/local/bin/curl -sfSL -o "$APP_DIR/octoeverywhere.zip" "$URL"; then
        echo "Download failed"
        return 1
    fi

    echo "Verifying SHA256 checksum..."
    ACTUAL_SHA256=$(sha256sum "$APP_DIR/octoeverywhere.zip" | awk '{print $1}')
    if [[ "$ACTUAL_SHA256" != "$SHA256" ]]; then
        echo "SHA256 mismatch!"
        echo "  Expected: $SHA256"
        echo "  Actual:   $ACTUAL_SHA256"
        return 1
    fi
    echo "Checksum verified."

    echo "Extracting..."
    if ! unzip -q "$APP_DIR/octoeverywhere.zip" -d "$APP_DIR"; then
        echo "Extraction failed"
        return 1
    fi
    echo "Extraction successful."

    rm -rf "$APP_DIR/octoeverywhere.zip"

    echo "Setting up Python virtual environment (this can take up to 60 seconds)..."
    if ! python3 -m venv "$APP_DIR/venv"; then
        echo "Failed to create virtual environment"
        return 1
    fi

    echo "Installing dependencies (this can also take a bit)..."
    if ! "$APP_DIR/venv/bin/pip" install --disable-pip-version-check -r "$APP_DIR/OctoPrint-OctoEverywhere-${VERSION}/requirements.txt"; then
        echo "Failed to install dependencies"
        return 1
    fi

    echo "Trying to install the optional zstdstandard package for better performance..."
    if ! "$APP_DIR/venv/bin/pip" install --disable-pip-version-check zstandard; then
        echo "Failed to install zstandard, continuing without it."
    fi

    # GitHub archives extract to OctoPrint-OctoEverywhere-<tag>
    ln -s "OctoPrint-OctoEverywhere-${VERSION}" "$APP_DIR/latest"
    echo "OctoEverywhere installed successfully to $APP_DIR"
}

case "$1" in
    check)
        check
        ;;
    download)
        if check; then
            echo "OctoEverywhere is already installed."
            exit 0
        fi
        if ! download; then
            rm -rf "$APP_DIR"
            exit 1
        fi
        ;;
    update)
        echo "Updating OctoEverywhere..."
        if ! download; then
            rm -rf "$APP_DIR"
            exit 1
        fi
        ;;
    clean)
        echo "Removing OctoEverywhere installation..."
        rm -rf "$APP_DIR"
        echo "Removed."
        ;;
    *)
        echo "Usage: $0 check|download|update|clean"
        exit 1
        ;;
esac
