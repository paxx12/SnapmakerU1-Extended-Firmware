#!/bin/bash

VERSION=1.92.5
URL="https://pkgs.tailscale.com/stable/tailscale_${VERSION}_arm64.tgz"
SHA256=13a59c3181337dfc9fdf9dea433b04c1fbf73f72ec059f64d87466b79a3a313c

TAILSCALE_DIR="/oem/apps/tailscale-${VERSION}"
TMP_DIR="$TAILSCALE_DIR.tmp"

case "$(basename "$0")" in
    tailscaled)
        if [[ ! -x "$TAILSCALE_DIR/tailscaled" ]]; then
            echo "Tailscale daemon not installed. Run 'tailscale-pkg download' first."
            exit 1
        fi
        exec "$TAILSCALE_DIR/tailscaled" "$@"
        ;;

    tailscale)
        if [[ ! -x "$TAILSCALE_DIR/tailscale" ]]; then
            echo "Tailscale client not installed. Run 'tailscale-pkg download' first."
            exit 1
        fi
        exec "$TAILSCALE_DIR/tailscale" "$@"
        ;;
esac

check() {
    if [[ -x "$TAILSCALE_DIR/tailscale" && -x "$TAILSCALE_DIR/tailscaled" ]]; then
        echo "Tailscale is installed (version $VERSION)."
        return 0
    else
        echo "Tailscale is not installed."
        return 1
    fi
}

download() {
    rm -rf "$TMP_DIR"
    mkdir -p "$TMP_DIR"

    echo "Downloading Tailscale $VERSION..."
    if ! /usr/local/bin/curl -fSL -o "$TMP_DIR/tailscale.tgz" "$URL"; then
        echo "Download failed"
        return 1
    fi

    echo "Verifying checksum..."
    if ! echo "$SHA256  $TMP_DIR/tailscale.tgz" | sha256sum -c; then
        echo "Checksum verification failed"
        return 1
    fi

    echo "Installing..."
    if ! tar --strip-components=1 -xzf "$TMP_DIR/tailscale.tgz" -C "$TMP_DIR"; then
        echo "Extraction failed"
        return 1
    fi

    if [[ ! -x "$TMP_DIR/tailscale" || ! -x "$TMP_DIR/tailscaled" ]]; then
        echo "Installation failed: binaries not found"
        return 1
    fi

    rm -rf "$TAILSCALE_DIR" "$TMP_DIR/tailscale.tgz"

    if ! mv "$TMP_DIR" "$TAILSCALE_DIR"; then
        echo "Failed to move Tailscale to $TAILSCALE_DIR"
        return 1
    fi

    echo "Tailscale $VERSION installed to $TAILSCALE_DIR"
}

case "$1" in
    check)
        check
        ;;
    download)
        if check; then
            echo "Tailscale is already installed."
            exit 0
        fi
        if ! download; then
            rm -rf "$TMP_DIR"
            exit 1
        fi
        ;;
    clean)
        echo "Removing Tailscale installation..."
        rm -rf "$TAILSCALE_DIR"
        echo "Removed."
        ;;
    *)
        echo "Usage: $0 check|download|clean"
        exit 1
        ;;
esac
