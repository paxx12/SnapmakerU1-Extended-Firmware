# Night Mode macros: manual toggle and profile tuning
# Defaults are overridden at runtime by the scheduler via SET_GCODE_VARIABLE.

[gcode_macro NIGHT_MODE_STATE]
description: Night Mode state (do not call directly)
variable_active: False
variable_motion_mode: ""
variable_saved_speed_factor: 1.0
variable_saved_accel: 0.0
variable_saved_square_corner_velocity: 0.0
variable_saved_fan_speed: 0.0
variable_profile_speed_pct: 75.0
variable_profile_accel: 6500.0
variable_profile_jerk: 5.0
variable_profile_fan_percent: 65.0
variable_profile_stepper_current_enabled: False
variable_profile_stepper_current_x: 1.0
variable_profile_stepper_current_y: 1.0
variable_profile_tmc_autotune_enabled: True
variable_saved_stepper_current_x: 0.0
variable_saved_stepper_current_y: 0.0
variable_manual_hold: 0

[gcode_macro NIGHT_MODE_SET_PROFILE]
description: Set Night Mode profile values (SPEED, ACCEL, JERK, FAN percent)
gcode:
    {% set state = printer["gcode_macro NIGHT_MODE_STATE"] %}
    {% set speed = params.SPEED|default(state.profile_speed_pct)|float %}
    {% set accel = params.ACCEL|default(state.profile_accel)|float %}
    {% set jerk = params.JERK|default(state.profile_jerk)|float %}
    {% set fan = params.FAN|default(state.profile_fan_percent)|float %}
    {% set current_enabled = params.CURRENT_ENABLED|default(state.profile_stepper_current_enabled)|string|lower in ["1", "true", "yes"] %}
    {% set current_x = params.CURRENT_X|default(state.profile_stepper_current_x)|float %}
    {% set current_y = params.CURRENT_Y|default(state.profile_stepper_current_y)|float %}
    {% set tmc_auto = params.AUTOTUNE_ENABLED|default(state.profile_tmc_autotune_enabled)|string|lower in ["1", "true", "yes"] %}
    {% set speed = 70.0 if speed < 70.0 else speed %}
    {% set accel = 5000.0 if accel < 5000.0 else accel %}
    {% set fan = 50.0 if fan < 50.0 else fan %}
    {% set fan = 100.0 if fan > 100.0 else fan %}
    {% set current_x = 0.1 if current_x < 0.1 else current_x %}
    {% set current_y = 0.1 if current_y < 0.1 else current_y %}
    {% set current_x = 2.5 if current_x > 2.5 else current_x %}
    {% set current_y = 2.5 if current_y > 2.5 else current_y %}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_speed_pct VALUE={speed}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_accel VALUE={accel}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_jerk VALUE={jerk}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_fan_percent VALUE={fan}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_stepper_current_enabled VALUE={1 if current_enabled else 0}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_stepper_current_x VALUE={current_x}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_stepper_current_y VALUE={current_y}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=profile_tmc_autotune_enabled VALUE={1 if tmc_auto else 0}
    RESPOND PREFIX=night_mode MSG="Profile set: speed {speed:.0f}% accel {accel:.0f} scv/jerk {jerk} fan {fan:.0f}% current_en {current_enabled} x {current_x:.2f} y {current_y:.2f} tmc_auto {tmc_auto}"

[gcode_macro NIGHT_MODE_ON]
description: Apply Night Mode quiet profile
gcode:
    {% set state = printer["gcode_macro NIGHT_MODE_STATE"] %}
    {% if state.active %}
        RESPOND PREFIX=night_mode MSG="Already active"
        RETURN
    {% endif %}
    {% set speed_pct = [state.profile_speed_pct, 70.0]|max %}
    {% set accel = [state.profile_accel, 5000.0]|max %}
    {% set scv = state.profile_jerk %}
    {% set fan_pct = state.profile_fan_percent %}
    {% if fan_pct < 50.0 %}{% set fan_pct = 50.0 %}{% endif %}
    {% if fan_pct > 100.0 %}{% set fan_pct = 100.0 %}{% endif %}
    {% set motion_mode = state.motion_mode %}
    {% if not motion_mode %}
        {% set cfg = printer.configfile.settings.printer %}
        {% set uses_classic = cfg.use_classic_jerk|default(false) or cfg.classic_jerk|default(false) or cfg.max_xy_jerk is defined or cfg.max_x_jerk is defined %}
        {% set motion_mode = 'classic_jerk' if uses_classic else 'junction_deviation' %}
        SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=motion_mode VALUE="'%s'" % motion_mode
    {% endif %}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=saved_speed_factor VALUE={printer.gcode.speed_factor}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=saved_accel VALUE={printer.toolhead.max_accel}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=saved_square_corner_velocity VALUE={printer.toolhead.square_corner_velocity|default(5.0)}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=saved_fan_speed VALUE={printer.fan.speed|default(0.0)}
    {% set tmc_x = printer.configfile.settings.get('tmc2240 stepper_x') if 'tmc2240 stepper_x' in printer.configfile.settings else (printer.configfile.settings.get('tmc2209 stepper_x') if 'tmc2209 stepper_x' in printer.configfile.settings else None) %}
    {% set tmc_y = printer.configfile.settings.get('tmc2240 stepper_y') if 'tmc2240 stepper_y' in printer.configfile.settings else (printer.configfile.settings.get('tmc2209 stepper_y') if 'tmc2209 stepper_y' in printer.configfile.settings else None) %}
    {% if state.profile_stepper_current_enabled %}
        {% if tmc_x %}
            SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=saved_stepper_current_x VALUE={{ tmc_x.run_current|default(0.0) }}
            SET_TMC_CURRENT STEPPER=stepper_x CURRENT={state.profile_stepper_current_x}
        {% endif %}
        {% if tmc_y %}
            SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=saved_stepper_current_y VALUE={{ tmc_y.run_current|default(0.0) }}
            SET_TMC_CURRENT STEPPER=stepper_y CURRENT={state.profile_stepper_current_y}
        {% endif %}
    {% endif %}
    {% if state.profile_tmc_autotune_enabled %}
        {% set cfg_x = printer.configfile.settings.get('tmc2240 stepper_x') %}
        {% if cfg_x %}
            SET_TMC_FIELD STEPPER=stepper_x FIELD=TOFF VALUE=5
            SET_TMC_FIELD STEPPER=stepper_x FIELD=HSTRT VALUE=7
            SET_TMC_FIELD STEPPER=stepper_x FIELD=HEND VALUE=9
            SET_TMC_FIELD STEPPER=stepper_x FIELD=TBL VALUE=1
            SET_TMC_FIELD STEPPER=stepper_x FIELD=TPFD VALUE=2
            SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_AUTOSCALE VALUE=1
            SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_AUTOGRAD VALUE=1
            SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_OFS VALUE=22
            SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_GRAD VALUE=13
            SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_REG VALUE=15
            SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_LIM VALUE=4
            SET_TMC_FIELD STEPPER=stepper_x FIELD=SEMIN VALUE=2
            SET_TMC_FIELD STEPPER=stepper_x FIELD=SEUP VALUE=3
            SET_TMC_FIELD STEPPER=stepper_x FIELD=SEMAX VALUE=4
            SET_TMC_FIELD STEPPER=stepper_x FIELD=SEDN VALUE=2
            SET_TMC_FIELD STEPPER=stepper_x FIELD=SEIMIN VALUE=1
            SET_TMC_FIELD STEPPER=stepper_x FIELD=MULTISTEP_FILT VALUE=1
            SET_TMC_FIELD STEPPER=stepper_x FIELD=IHOLDDELAY VALUE=12
            SET_TMC_FIELD STEPPER=stepper_x FIELD=IRUNDELAY VALUE=0
        {% endif %}
        {% set cfg_y = printer.configfile.settings.get('tmc2240 stepper_y') %}
        {% if cfg_y %}
            SET_TMC_FIELD STEPPER=stepper_y FIELD=TOFF VALUE=5
            SET_TMC_FIELD STEPPER=stepper_y FIELD=HSTRT VALUE=7
            SET_TMC_FIELD STEPPER=stepper_y FIELD=HEND VALUE=9
            SET_TMC_FIELD STEPPER=stepper_y FIELD=TBL VALUE=1
            SET_TMC_FIELD STEPPER=stepper_y FIELD=TPFD VALUE=2
            SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_AUTOSCALE VALUE=1
            SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_AUTOGRAD VALUE=1
            SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_OFS VALUE=22
            SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_GRAD VALUE=13
            SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_REG VALUE=15
            SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_LIM VALUE=4
            SET_TMC_FIELD STEPPER=stepper_y FIELD=SEMIN VALUE=2
            SET_TMC_FIELD STEPPER=stepper_y FIELD=SEUP VALUE=3
            SET_TMC_FIELD STEPPER=stepper_y FIELD=SEMAX VALUE=4
            SET_TMC_FIELD STEPPER=stepper_y FIELD=SEDN VALUE=2
            SET_TMC_FIELD STEPPER=stepper_y FIELD=SEIMIN VALUE=1
            SET_TMC_FIELD STEPPER=stepper_y FIELD=MULTISTEP_FILT VALUE=1
            SET_TMC_FIELD STEPPER=stepper_y FIELD=IHOLDDELAY VALUE=12
            SET_TMC_FIELD STEPPER=stepper_y FIELD=IRUNDELAY VALUE=0
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=manual_hold VALUE=0
    M220 S{speed_pct|int}
    SET_VELOCITY_LIMIT ACCEL={accel} SQUARE_CORNER_VELOCITY={scv}
    M106 S{(fan_pct/100.0*255)|int}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=active VALUE=True
    RESPOND PREFIX=night_mode MSG="Enabled (speed {speed_pct:.0f}% accel {accel:.0f} scv {scv} fan {fan_pct:.0f}%)"

[gcode_macro NIGHT_MODE_OFF]
description: Restore pre-Night Mode parameters (HOLD=1 prevents schedule re-enable this window)
gcode:
    {% set state = printer["gcode_macro NIGHT_MODE_STATE"] %}
    {% set hold = params.HOLD|default(0)|int %}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=manual_hold VALUE={1 if hold > 0 else 0}
    {% if not state.active %}
        RESPOND PREFIX=night_mode MSG="Already inactive"
        RETURN
    {% endif %}
    {% set profile_speed = state.profile_speed_pct/100.0 %}
    {% set profile_fan = state.profile_fan_percent/100.0 %}
    {% set current_speed = printer.gcode.speed_factor %}
    {% set current_fan = printer.fan.speed|default(0.0) %}
    {% if abs(current_speed - profile_speed) < 0.001 %}
        M220 S{(state.saved_speed_factor * 100)|int}
    {% endif %}
    SET_VELOCITY_LIMIT ACCEL={state.saved_accel} SQUARE_CORNER_VELOCITY={state.saved_square_corner_velocity}
    {% if abs(current_fan - profile_fan) < 0.01 %}
        M106 S{(state.saved_fan_speed * 255)|int}
    {% endif %}
    {% if state.profile_stepper_current_enabled %}
        {% if state.saved_stepper_current_x > 0 %}
            SET_TMC_CURRENT STEPPER=stepper_x CURRENT={state.saved_stepper_current_x}
        {% endif %}
        {% if state.saved_stepper_current_y > 0 %}
            SET_TMC_CURRENT STEPPER=stepper_y CURRENT={state.saved_stepper_current_y}
        {% endif %}
    {% endif %}
    {% if state.profile_tmc_autotune_enabled %}
        {% set cfg_x = printer.configfile.settings.get('tmc2240 stepper_x') %}
        {% if cfg_x %}
            {% if cfg_x.driver_toff is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=TOFF VALUE={{ cfg_x.driver_toff }}{% endif %}
            {% if cfg_x.driver_hstrt is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=HSTRT VALUE={{ cfg_x.driver_hstrt }}{% endif %}
            {% if cfg_x.driver_hend is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=HEND VALUE={{ cfg_x.driver_hend }}{% endif %}
            {% if cfg_x.driver_tbl is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=TBL VALUE={{ cfg_x.driver_tbl }}{% endif %}
            {% if cfg_x.driver_tpfd is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=TPFD VALUE={{ cfg_x.driver_tpfd }}{% endif %}
            {% if cfg_x.driver_pwm_autoscale is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_AUTOSCALE VALUE={{ 1 if cfg_x.driver_pwm_autoscale else 0 }}{% endif %}
            {% if cfg_x.driver_pwm_autograd is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_AUTOGRAD VALUE={{ 1 if cfg_x.driver_pwm_autograd else 0 }}{% endif %}
            {% if cfg_x.driver_pwm_ofs is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_OFS VALUE={{ cfg_x.driver_pwm_ofs }}{% endif %}
            {% if cfg_x.driver_pwm_grad is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_GRAD VALUE={{ cfg_x.driver_pwm_grad }}{% endif %}
            {% if cfg_x.driver_pwm_reg is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_REG VALUE={{ cfg_x.driver_pwm_reg }}{% endif %}
            {% if cfg_x.driver_pwm_lim is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=PWM_LIM VALUE={{ cfg_x.driver_pwm_lim }}{% endif %}
            {% if cfg_x.driver_semin is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=SEMIN VALUE={{ cfg_x.driver_semin }}{% endif %}
            {% if cfg_x.driver_seup is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=SEUP VALUE={{ cfg_x.driver_seup }}{% endif %}
            {% if cfg_x.driver_semax is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=SEMAX VALUE={{ cfg_x.driver_semax }}{% endif %}
            {% if cfg_x.driver_sedn is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=SEDN VALUE={{ cfg_x.driver_sedn }}{% endif %}
            {% if cfg_x.driver_seimin is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=SEIMIN VALUE={{ cfg_x.driver_seimin }}{% endif %}
            {% if cfg_x.driver_multistep_filt is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=MULTISTEP_FILT VALUE={{ 1 if cfg_x.driver_multistep_filt else 0 }}{% endif %}
            {% if cfg_x.driver_iholddelay is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=IHOLDDELAY VALUE={{ cfg_x.driver_iholddelay }}{% endif %}
            {% if cfg_x.driver_irundelay is defined %}SET_TMC_FIELD STEPPER=stepper_x FIELD=IRUNDELAY VALUE={{ cfg_x.driver_irundelay }}{% endif %}
        {% endif %}
        {% set cfg_y = printer.configfile.settings.get('tmc2240 stepper_y') %}
        {% if cfg_y %}
            {% if cfg_y.driver_toff is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=TOFF VALUE={{ cfg_y.driver_toff }}{% endif %}
            {% if cfg_y.driver_hstrt is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=HSTRT VALUE={{ cfg_y.driver_hstrt }}{% endif %}
            {% if cfg_y.driver_hend is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=HEND VALUE={{ cfg_y.driver_hend }}{% endif %}
            {% if cfg_y.driver_tbl is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=TBL VALUE={{ cfg_y.driver_tbl }}{% endif %}
            {% if cfg_y.driver_tpfd is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=TPFD VALUE={{ cfg_y.driver_tpfd }}{% endif %}
            {% if cfg_y.driver_pwm_autoscale is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_AUTOSCALE VALUE={{ 1 if cfg_y.driver_pwm_autoscale else 0 }}{% endif %}
            {% if cfg_y.driver_pwm_autograd is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_AUTOGRAD VALUE={{ 1 if cfg_y.driver_pwm_autograd else 0 }}{% endif %}
            {% if cfg_y.driver_pwm_ofs is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_OFS VALUE={{ cfg_y.driver_pwm_ofs }}{% endif %}
            {% if cfg_y.driver_pwm_grad is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_GRAD VALUE={{ cfg_y.driver_pwm_grad }}{% endif %}
            {% if cfg_y.driver_pwm_reg is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_REG VALUE={{ cfg_y.driver_pwm_reg }}{% endif %}
            {% if cfg_y.driver_pwm_lim is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=PWM_LIM VALUE={{ cfg_y.driver_pwm_lim }}{% endif %}
            {% if cfg_y.driver_semin is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=SEMIN VALUE={{ cfg_y.driver_semin }}{% endif %}
            {% if cfg_y.driver_seup is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=SEUP VALUE={{ cfg_y.driver_seup }}{% endif %}
            {% if cfg_y.driver_semax is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=SEMAX VALUE={{ cfg_y.driver_semax }}{% endif %}
            {% if cfg_y.driver_sedn is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=SEDN VALUE={{ cfg_y.driver_sedn }}{% endif %}
            {% if cfg_y.driver_seimin is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=SEIMIN VALUE={{ cfg_y.driver_seimin }}{% endif %}
            {% if cfg_y.driver_multistep_filt is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=MULTISTEP_FILT VALUE={{ 1 if cfg_y.driver_multistep_filt else 0 }}{% endif %}
            {% if cfg_y.driver_iholddelay is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=IHOLDDELAY VALUE={{ cfg_y.driver_iholddelay }}{% endif %}
            {% if cfg_y.driver_irundelay is defined %}SET_TMC_FIELD STEPPER=stepper_y FIELD=IRUNDELAY VALUE={{ cfg_y.driver_irundelay }}{% endif %}
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=NIGHT_MODE_STATE VARIABLE=active VALUE=False
    RESPOND PREFIX=night_mode MSG="Disabled{ ' (hold until window ends)' if hold > 0 else '' }"

[gcode_macro NIGHT_MODE_TOGGLE]
description: Toggle Night Mode (HOLD=1 passes through to OFF)
gcode:
    {% if printer["gcode_macro NIGHT_MODE_STATE"].active %}
        NIGHT_MODE_OFF { 'HOLD=1' if params.HOLD|default(0)|int > 0 else '' }
    {% else %}
        NIGHT_MODE_ON
    {% endif %}

[gcode_macro NIGHT_MODE_STATUS]
description: Print current Night Mode status
gcode:
    {% set state = printer["gcode_macro NIGHT_MODE_STATE"] %}
    {% set status = 'active' if state.active else 'inactive' %}
    RESPOND PREFIX=night_mode MSG="Status: {status}, profile speed {state.profile_speed_pct:.0f}% accel {state.profile_accel:.0f} scv {state.profile_jerk} fan {state.profile_fan_percent:.0f}% current_en {state.profile_stepper_current_enabled} x {state.profile_stepper_current_x:.2f} y {state.profile_stepper_current_y:.2f} tmc_auto {state.profile_tmc_autotune_enabled}"
