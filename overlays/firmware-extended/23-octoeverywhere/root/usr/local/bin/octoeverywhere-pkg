#!/bin/bash


#
# OctoEverywhere package manager
# Downloads and installs a pinned version of OctoEverywhere from GitHub
#

GIT_TAG_VERSION="4.6.1"
EXPECTED_TAG_SHA256="a735b1f19c9dcdc09ceca4ab98b7de54f25e75923229c9e8474969f99368de63"

REPO_URL="https://github.com/QuinnDamerell/OctoPrint-OctoEverywhere/archive/refs/tags/${GIT_TAG_VERSION}.zip"
TMP_DIR="/oem/apps/octoeverywhere.tmp"

# These paths are referenced in the init.d script
INSTALL_DIR="/oem/apps/octoeverywhere"
VENV_DIR="/oem/apps/octoeverywhere-env"

check() {
    if [[ -d "$INSTALL_DIR" && -d "$VENV_DIR" && -f "$INSTALL_DIR/moonraker_octoeverywhere.py" ]]; then
        echo "OctoEverywhere is installed."
        return 0
    else
        echo "OctoEverywhere is not installed."
        return 1
    fi
}

download() {
    rm -rf "$TMP_DIR"
    mkdir -p "$TMP_DIR"

    echo "Downloading OctoEverywhere ${GIT_TAG_VERSION}..."
    if ! /usr/local/bin/curl -fSL -o "$TMP_DIR/octoeverywhere.zip" "$REPO_URL"; then
        echo "Download failed"
        return 1
    fi

    echo "Verifying SHA256 checksum..."
    ACTUAL_SHA256=$(sha256sum "$TMP_DIR/octoeverywhere.zip" | awk '{print $1}')
    if [[ "$ACTUAL_SHA256" != "$EXPECTED_TAG_SHA256" ]]; then
        echo "SHA256 mismatch!"
        echo "  Expected: $EXPECTED_TAG_SHA256"
        echo "  Actual:   $ACTUAL_SHA256"
        return 1
    fi
    echo "Checksum verified."

    echo "Extracting..."
    if ! unzip -q "$TMP_DIR/octoeverywhere.zip" -d "$TMP_DIR"; then
        echo "Extraction failed"
        return 1
    fi

    rm -rf "$INSTALL_DIR"

    # GitHub archives extract to OctoPrint-OctoEverywhere-<tag>
    EXTRACT_DIR="$TMP_DIR/OctoPrint-OctoEverywhere-${GIT_TAG_VERSION}"
    if ! mv "$EXTRACT_DIR" "$INSTALL_DIR"; then
        echo "Failed to move OctoEverywhere to $INSTALL_DIR"
        return 1
    fi

    rm -rf "$TMP_DIR"

    echo "Setting up Python virtual environment..."
    if ! python3 -m venv "$VENV_DIR"; then
        echo "Failed to create virtual environment"
        return 1
    fi

    echo "Installing dependencies..."
    if ! "$VENV_DIR/bin/pip" install --quiet -r "$INSTALL_DIR/requirements.txt"; then
        echo "Failed to install dependencies"
        return 1
    fi

    echo "Trying to install the optional zstdstandard package for better performance..."
    if ! "$VENV_DIR/bin/pip" install --quiet zstandard; then
        echo "Failed to install zstandard, continuing without it."
    fi

    echo "OctoEverywhere installed to $INSTALL_DIR"
}

case "$1" in
    check)
        check
        ;;
    download)
        if check; then
            echo "OctoEverywhere is already installed."
            exit 0
        fi
        if ! download; then
            rm -rf "$TMP_DIR"
            exit 1
        fi
        ;;
    update)
        echo "Updating OctoEverywhere..."
        if ! download; then
            rm -rf "$TMP_DIR"
            exit 1
        fi
        ;;
    clean)
        echo "Removing OctoEverywhere installation..."
        rm -rf "$INSTALL_DIR" "$VENV_DIR"
        echo "Removed."
        ;;
    *)
        echo "Usage: $0 check|download|update|clean"
        exit 1
        ;;
esac
